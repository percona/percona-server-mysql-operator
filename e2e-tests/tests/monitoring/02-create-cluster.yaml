apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      get_cr \
          | yq eval '.spec.secretsName="test-secrets"' - \
          | yq eval '.spec.mysql.clusterType="async"' - \
          | yq eval '.spec.pmm.enabled = true' - \
          | yq eval '.spec.pmm.mysqlParams = "--disable-tablestats-limit=2000"' - \
          | yq eval '.spec.pmm.readinessProbe.initialDelaySeconds = 15' - \
          | yq eval '.spec.pmm.readinessProbe.timeoutSeconds = 15' - \
          | yq eval '.spec.pmm.readinessProbe.periodSeconds = 30' - \
          | yq eval '.spec.pmm.readinessProbe.successThreshold = 1' - \
          | yq eval '.spec.pmm.readinessProbe.failureThreshold = 5' - \
          | yq eval '.spec.pmm.livenessProbe.initialDelaySeconds = 15' - \
          | yq eval '.spec.pmm.livenessProbe.timeoutSeconds = 15' - \
          | yq eval '.spec.pmm.livenessProbe.periodSeconds = 30' - \
          | yq eval '.spec.pmm.livenessProbe.successThreshold = 1' - \
          | yq eval '.spec.pmm.livenessProbe.failureThreshold = 5' - \
          | yq eval '.spec.proxy.haproxy.enabled = true' - \
          | yq eval '.spec.proxy.haproxy.expose.type = "LoadBalancer"' - \
          | kubectl -n "${NAMESPACE}" apply -f -
    timeout: 10
