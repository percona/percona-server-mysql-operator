apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      suffix="ref"
      get_cr $suffix \
          | yq eval '.spec.secretsName="internal-async-data-source-initial"' - \
          | yq eval '.spec.mysql.clusterType="async"' - \
          | yq eval '.spec.mysql.size=3' - \
          | yq eval '.spec.proxy.haproxy.enabled=true' - \
          | yq eval '.spec.proxy.haproxy.size=3' - \
          | yq eval '.spec.orchestrator.enabled=true' - \
          | yq eval '.spec.orchestrator.size=3' - \
          | yq eval '.spec.mysql.volumeSpec.persistentVolumeClaim.resources.requests.storage="3Gi"' - \
          | yq eval '.spec.mysql.volumeSpec.persistentVolumeClaim.dataSourceRef.kind="PersistentVolumeClaim"' - \
          | yq eval '.spec.mysql.volumeSpec.persistentVolumeClaim.dataSourceRef.name="datadir-async-data-source-initial-mysql-0"' - \
          | kubectl -n "${NAMESPACE}" apply -f -
    timeout: 180
