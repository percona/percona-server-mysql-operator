apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - timeout: 60
    script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      haproxy_svc="$(get_haproxy_svc $(get_cluster_name))"
      run_mysql \
          "CREATE DATABASE IF NOT EXISTS pvctest; CREATE TABLE IF NOT EXISTS pvctest.data (id int PRIMARY KEY, data text)" \
          "-h $haproxy_svc"

      run_mysql_query_file "conf/initial-data.sql" "-h $haproxy_svc"

      # Store initial data count for verification
      count=$(run_mysql "SELECT COUNT(*) FROM pvctest.data" "-h $haproxy_svc")
      kubectl create configmap -n "${NAMESPACE}" initial-data-count --from-literal=count="${count}"
