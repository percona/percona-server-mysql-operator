apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - timeout: 180
    script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      run_mysql_with_root \
          "CREATE DATABASE IF NOT EXISTS pvctest; CREATE TABLE IF NOT EXISTS pvctest.data (id int PRIMARY KEY, data text)" \
          "-h $(get_haproxy_svc $(get_cluster_name))"

      for i in {1..50}; do
          run_mysql_with_root \
              "INSERT pvctest.data (id, data) VALUES ($i, 'test data row $i with some content to use storage space')" \
              "-h $(get_haproxy_svc $(get_cluster_name))"
      done

      # Store initial data count for verification
      count=$(run_mysql_with_root "SELECT COUNT(*) FROM pvctest.data" "-h $(get_haproxy_svc $(get_cluster_name))")
      kubectl create configmap -n "${NAMESPACE}" initial-data-count --from-literal=count="${count}"
