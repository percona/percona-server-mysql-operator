apiVersion: kuttl.dev/v1beta1
kind: TestStep
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      args=""

      primary=$(run_mysql_with_root "SELECT count(*) FROM myDB.myTable" "-h $(get_haproxy_svc $(get_cluster_name))")
      args="${args} --from-literal=primary=${primary}"

      replica=$(run_mysql_with_root "SELECT count(*) FROM myDB.myTable" "-h $(get_haproxy_svc $(get_cluster_name)) -P 3307")
      args="${args} --from-literal=replica=${replica}"

      # uncomment after https://jira.percona.com/browse/K8SPS-284
      # proxy_protocol=$(run_mysql_with_root "SELECT count(*) FROM myDB.myTable" "-h $(get_haproxy_svc $(get_cluster_name)) -P 3309")
      # args="${args} --from-literal=proxy_protocol=${proxy_protocol}"

      root_password=$(get_user_pass root)
      mysqlx=$(run_mysqlsh_with_root "SELECT count(*) FROM myDB.myTable" "-h $(get_haproxy_svc $(get_cluster_name)) -P 33060")
      args="${args} --from-literal=mysqlx=${mysqlx}"

      mysql_admin=$(run_mysql_with_root "SELECT count(*) FROM myDB.myTable" "-h $(get_haproxy_svc $(get_cluster_name)) -P 33062")
      args="${args} --from-literal=mysql_admin=${mysql_admin}"

      kubectl create configmap -n "${NAMESPACE}" 03-check-connections $args
    timeout: 30
