apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 10
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions
      init_temp_dir # do this only in the first TestStep

      deploy_operator_with_telemetry() {
        destroy_operator

        if [[ $OPERATOR_NS ]]; then
          create_namespace "${OPERATOR_NS}"
        fi

        kubectl -n "${OPERATOR_NS:-$NAMESPACE}" apply --server-side --force-conflicts -f "${DEPLOY_DIR}/crd.yaml"

        if [ -n "$OPERATOR_NS" ]; then
          kubectl -n "${OPERATOR_NS:-$NAMESPACE}" apply -f "${DEPLOY_DIR}/cw-rbac.yaml"

          yq eval \
            "$(printf 'select(documentIndex==1).spec.template.spec.containers[0].image="%s"' "${IMAGE}")" \
            "${DEPLOY_DIR}/cw-operator.yaml" \
            | yq eval '(select(documentIndex==1).spec.template.spec.containers[] | select(.name=="manager").env[] | select(.name=="DISABLE_TELEMETRY").value) = "false"' \
            | yq eval '(select(documentIndex==1).spec.template.spec.containers[] | select(.name=="manager").env[] | select(.name=="LOG_LEVEL").value) = "DEBUG"' \
            | yq eval 'select(documentIndex==1).spec.template.spec.containers[] |= (select(.name=="manager").env += [{"name":"TELEMETRY_SCHEDULE","value":"* * * * *"}])' \
            | yq eval 'select(documentIndex==1).spec.template.spec.containers[] |= (select(.name=="manager").env += [{"name":"TELEMETRY_SERVICE_URL","value":"https://check-dev.percona.com"}])' \
            | kubectl -n "${OPERATOR_NS:-$NAMESPACE}" apply -f -
        else
          kubectl -n "${OPERATOR_NS:-$NAMESPACE}" apply -f "${DEPLOY_DIR}/rbac.yaml"

          yq eval \
            "$(printf 'select(documentIndex==1).spec.template.spec.containers[0].image="%s"' "${IMAGE}")" \
            "${DEPLOY_DIR}/operator.yaml" \
            | yq eval '(select(documentIndex==1).spec.template.spec.containers[] | select(.name=="manager").env[] | select(.name=="DISABLE_TELEMETRY").value) = "false"' \
            | yq eval '(select(documentIndex==1).spec.template.spec.containers[] | select(.name=="manager").env[] | select(.name=="LOG_LEVEL").value) = "DEBUG"' \
            | yq eval 'select(documentIndex==1).spec.template.spec.containers[] |= (select(.name=="manager").env += [{"name":"TELEMETRY_SCHEDULE","value":"* * * * *"}])' \
            | yq eval 'select(documentIndex==1).spec.template.spec.containers[] |= (select(.name=="manager").env += [{"name":"TELEMETRY_SERVICE_URL","value":"https://check-dev.percona.com"}])' \
            | kubectl -n "${OPERATOR_NS:-$NAMESPACE}" apply -f -
        fi
      }

      deploy_operator_with_telemetry
      deploy_non_tls_cluster_secrets
      deploy_tls_cluster_secrets
      deploy_client
