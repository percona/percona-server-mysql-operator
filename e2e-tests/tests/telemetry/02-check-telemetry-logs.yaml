apiVersion: kuttl.dev/v1beta1
kind: TestStep
timeout: 180
commands:
  - script: |-
      set -o errexit
      set -o xtrace

      source ../../functions

      echo "Waiting for telemetry to be sent..."

      # TELEMETRY_SCHEDULE is set to * * * * *, so we wait...
      sleep 120

      OPERATOR_POD=$(get_operator_pod)
      echo "Operator pod: $OPERATOR_POD"

      echo "Checking operator logs for telemetry reports..."

      if kubectl logs -n "${OPERATOR_NS:-$NAMESPACE}" "$OPERATOR_POD" | grep -i "generated telemetry report"; then
        echo "Found telemetry report generation in logs"
      else
        echo "Telemetry report generation not found"
        exit 1
      fi

      if kubectl logs -n "${OPERATOR_NS:-$NAMESPACE}" "$OPERATOR_POD" | grep -E "(telemetry|report.*percona)" -i; then
        echo "Found telemetry activity in logs"
      else
        echo "No telemetry activity found in logs"
        exit 1
      fi

