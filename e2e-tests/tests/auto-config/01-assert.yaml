apiVersion: kuttl.dev/v1beta1
kind: TestAssert
timeout: 420
---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  generation: 1
  name: auto-config-mysql
spec:
  template:
    spec:
      containers:
      - name: mysql
        volumeMounts:
        - mountPath: /opt/percona
          name: bin
        - mountPath: /var/lib/mysql
          name: datadir
        - mountPath: /.mysqlsh
          name: mysqlsh
        - mountPath: /etc/mysql/mysql-users-secret
          name: users
        - mountPath: /etc/mysql/mysql-tls-secret
          name: tls
        - mountPath: /etc/mysql/config
          name: config
        - mountPath: /etc/mysql/vault-keyring-secret
          name: vault-keyring-secret
      - name: xtrabackup
        volumeMounts:
        - mountPath: /opt/percona
          name: bin
        - mountPath: /var/lib/mysql
          name: datadir
        - mountPath: /etc/mysql/mysql-users-secret
          name: users
        - mountPath: /var/log/xtrabackup
          name: backup-logs
        - mountPath: /etc/mysql/vault-keyring-secret
          name: vault-keyring-secret
      - name: pt-heartbeat
        volumeMounts:
        - mountPath: /opt/percona
          name: bin
        - mountPath: /var/lib/mysql
          name: datadir
        - mountPath: /etc/mysql/mysql-users-secret
          name: users
      volumes:
      - emptyDir: {}
        name: bin
      - emptyDir: {}
        name: mysqlsh
      - name: users
        secret:
          defaultMode: 420
          secretName: internal-auto-config
      - name: tls
        secret:
          defaultMode: 420
          secretName: test-ssl
      - name: config
        projected:
          defaultMode: 420
          sources:
          - configMap:
              items:
              - key: my.cnf
                path: my-config.cnf
              name: auto-config-mysql
              optional: true
          - configMap:
              items:
              - key: my.cnf
                path: auto-config.cnf
              name: auto-auto-config-mysql
              optional: true
          - secret:
              items:
              - key: my.cnf
                path: my-secret.cnf
              name: auto-config-mysql
              optional: true
      - emptyDir: {}
        name: backup-logs
      - name: vault-keyring-secret
        secret:
          defaultMode: 420
          optional: true
          secretName: auto-config-vault
status:
  observedGeneration: 1
  replicas: 3
  readyReplicas: 3
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: auto-auto-config-mysql
  ownerReferences:
  - apiVersion: ps.percona.com/v1
    blockOwnerDeletion: true
    controller: true
    kind: PerconaServerMySQL
    name: auto-config
data:
  my.cnf: |2-

    innodb_buffer_pool_size=2147483648
    innodb_buffer_pool_chunk_size=268435456
    max_connections=341
